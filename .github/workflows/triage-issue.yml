name: AI Issue Triage
run-name: "AI Issue Triage: ${{ github.event.issue.title || github.event_name }} #${{ github.event.issue.number || inputs.issue_number || '-' }}"
permissions:
  issues: write
  contents: read

on:
  issues:
    types: [opened]
  workflow_dispatch:
    inputs:
      issue_number:
        description: Issue number
        required: false
        type: number
      include_comments:
        description: Include comments
        type: boolean
        default: false
      keys_values:
        description: Process as an 'api keys/values' issue
        type: boolean
        default: false
      dry_run:
        description: Dry run (do not modify issue)
        type: boolean
        default: true

jobs:
  triage-logic:
    outputs:
      issue_number: ${{ steps.triage.outputs.issue_number }}
      type:         ${{ steps.triage.outputs.type }}
    runs-on: ubuntu-latest
    steps:
      - name: Determine triage type
        id: triage
        uses: actions/github-script@v7
        with:
          result-encoding: string
          script: | #javascript
            core.debug(`Event payload:\n${JSON.stringify(context.payload, null, 4)}`);

            // Resolve issue number
            const issue_number = context.payload.issue?.number
                ?? Number(context.payload.inputs?.issue_number || 0);
  
            // Resolve type
            const isKeysValues =
              context.payload.issue?.labels.some(l => l.name === 'api keys/values')
              || context.payload.inputs?.keys_values === 'true';
            const type = isKeysValues ? (issue_number ? 'keys-values' : 'keys-values-batch') : 'general';
            if (type === 'general' && !issue_number) {
              core.setFailed('issue_number is required for general triage');
            }
  
            // Set step outputs and add to the workflow summary
            core.setOutput('issue_number', issue_number);
            core.setOutput('type', type);
            await core.summary
                .addTable([
                    ['Trigger', 'Issue', 'Type'].map(data => ({ data, header: true })),
                    [context.eventName, `#${issue_number || 'â€”'}`, type],
                ]).write();

  keys-values-validate:
    needs: [triage-logic]
    if: contains(fromJson('["keys-values", "keys-values-batch"]'), needs.triage-logic.outputs.type)
    runs-on: ubuntu-latest
    outputs:
      status:   ${{ steps.validate.outputs.status }}
      context:  ${{ steps.validate.outputs.context }}
      comment:  ${{ steps.validate.outputs.comment }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Run the validation script
        id: validate
        run: npx tsx bin/issue-api-keys.ts
        env:
          ISSUE_NUMBER: ${{ needs.triage-logic.outputs.issue_number }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  plugin-test:
    needs: [triage-logic]
    if: needs.triage-logic.outputs.type == 'general'
    runs-on: ubuntu-latest
    outputs:
      name: Plugin Test
      name_md: >- # markdown
        Plugin Test ${{ steps.context.outputs.version_md }}
      value: ${{ steps.context.outputs.value }}
      prompt: |-
        Automated test of HEAD (latest development version) start-up against Homebridge and the live Home Connect API.
        Tests initialisation with Siemens iQ700 Dishwasher (SN678D06TG/53), Induction Hob (EX677LYV1E/06), and Single Oven (HB678GBS6B/58).
        If the test only shows routine start-up with no related commits or errors, assess applicability based on whether start-up testing can diagnose the specific issue type.
        Ignore any errors that might be due to appliances being off-line.
        Check for commit messages or log highlights that might indicate fixes or changes related to the reported issue.
    env:
      LOG_FILE: ${{ github.workspace }}/test.log
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      - name: Install dependencies and build
        run: | #shell
          npm ci
          npm install homebridge
          cp -R ./.devcontainer/.homebridge ~/
          npm run build
      - id: test
        name: Run the tests
        env:
          HOMECONNECT_CLIENT_PHYSICAL:  ${{ secrets.HOMECONNECT_CLIENT_PHYSICAL }}
          HOMECONNECT_CLIENT_SIMULATOR: ${{ secrets.HOMECONNECT_CLIENT_SIMULATOR }}
        run: | # shell
          npm run test 2>&1 | tee "$LOG_FILE"
          echo "exit_code=${PIPESTATUS[0]}" >> "$GITHUB_OUTPUT"
      - name: Process the test result
        id: context
        uses: thoukydides/action-test-context@v1
        with:
          exit_code:    ${{ steps.test.outputs.exit_code }}
          log_file:     ${{ env.LOG_FILE }}
          log_regexps: |
            /(?<!\w)v?\d+\.\d+\.\d+/

  homeconnect-api-status:
    needs: [triage-logic]
    if: needs.triage-logic.outputs.type == 'general'
    runs-on: ubuntu-latest
    outputs:
      name: Home Connect API status
      name_md: >- # markdown
        Home Connect [API status](https://homeconnect.thouky.co.uk)
      prompt: |-
        Live monitoring of Home Connect cloud API availability and errors.
        States prefixed with 'maybe-' indicate uncertainty about fault location, not lower severity.
        Only relevant to issues that could be caused by API unavailability or errors.
      value: ${{ steps.fetch.outputs.status }}
    steps:
      - name: Retrieve Home Connect API status
        id: fetch
        env:
          AUTHORIZATION: Bearer ${{ secrets.HOMECONNECT_STATUS_BEARER_TOKEN }}
          URL: https://homeconnect.thouky.co.uk/api/data/context
        run: | # shell
          STATUS=$(curl -s -H "Authorization: $AUTHORIZATION" "$URL")
          printf 'status=%s\n' "$STATUS" >> "$GITHUB_OUTPUT"

  homeconnect-api-changelog-fetch:
    needs: [triage-logic]
    if: needs.triage-logic.outputs.type != 'keys-values-batch'
    runs-on: ubuntu-latest
    outputs:
      value: ${{ steps.fetch.outputs.releases }}
    steps:
      - name: Retrieve Home Connect API changelog
        id: fetch
        uses: thoukydides/action-releases-context@v1
        with:
          html_url: https://developer.home-connect.com/changelog
          html_regexps: |
            /<(\/?)header[^>]*>/i '<$1h1>'
            /<\/article>.*$/s
          md_release_regexp: |
            /^#\s+(?<date>\w+ \d\d?, \d\d\d\d)\s*$/m

  homeconnect-api-changelog:
    needs: [triage-logic, homeconnect-api-changelog-fetch]
    if: ${{ !cancelled() && needs.homeconnect-api-changelog-fetch.result != 'skipped' && needs.triage-logic.outputs.type == 'general' }}
    runs-on: ubuntu-latest
    outputs:
      name: Home Connect API changes
      name_md: >- # markdown
        Home Connect [API changes](https://developer.home-connect.com/changelog)
      prompt: |-
        Official changelog for the Home Connect cloud API.
        Only relevant if the issue could be caused by API changes (new appliance types, new programs/options, API behaviour changes).
      value: ${{ needs.homeconnect-api-changelog-fetch.outputs.value }}
    steps:
      - run: | #shell
          [[ "${{ needs.homeconnect-api-changelog-fetch.result }}" == "success" ]] || false

  homebridge-releases:
    needs: [triage-logic]
    if: needs.triage-logic.outputs.type == 'general'
    runs-on: ubuntu-latest
    outputs:
      name: Homebridge recent releases
      name_md: >- # markdown
        Homebridge [releases](https://github.com/homebridge/homebridge/releases)
      value: ${{ steps.fetch.outputs.releases }}
    steps:
      - name: Retrieve Homebridge releases
        id: fetch
        uses: thoukydides/action-releases-context@v1
        with:
          repository: homebridge/homebridge

  homebridge-ui-releases:
    needs: [triage-logic]
    if: needs.triage-logic.outputs.type == 'general'
    runs-on: ubuntu-latest
    outputs:
      name: Homebridge UI recent releases
      name_md: >- # markdown
        Homebridge UI [releases](https://github.com/homebridge/homebridge-config-ui-x/releases)
      value: ${{ steps.fetch.outputs.releases }}
    steps:
      - name: Retrieve Homebridge UI releases
        id: fetch
        uses: thoukydides/action-releases-context@v1
        with:
          repository: homebridge/homebridge-config-ui-x

  hap-nodejs-releases:
    needs: [triage-logic]
    if: false
    runs-on: ubuntu-latest
    outputs:
      name: HAP-NodeJS recent releases
      name_md: >- # markdown
        HAP-NodeJS [releases](https://github.com/homebridge/HAP-NodeJS/releases)
      value: ${{ steps.fetch.outputs.releases }}
    steps:
      - name: Retrieve HAP-NodeJS releases
        id: fetch
        uses: thoukydides/action-releases-context@v1
        with:
          repository: homebridge/HAP-NodeJS

  general-collate:
    if: ${{ !cancelled() }}
    runs-on: ubuntu-latest
    needs:
      - plugin-test
      - homeconnect-api-status
      - homeconnect-api-changelog
      - homebridge-releases
      - homebridge-ui-releases
      - hap-nodejs-releases
    outputs:
      needs: ${{ toJSON(needs) }}
    steps:
      - run: true

  general-comment:
    needs:
      - triage-logic
      - general-collate
    if: ${{ !cancelled() && needs.triage-logic.outputs.type == 'general' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: AI issue triage
        uses: thoukydides/action-triage-issue-comment@v1
        with:
          gemini_api_key:       ${{ secrets.GEMINI_API_KEY_TRIAGE }}
          issue_number:         ${{ github.event.issue.number || fromJson(inputs.issue_number) }}
          include_comments:     ${{ inputs.include_comments != false }}
          guidance_file:        ./.github/prompts/issue-quality-guidance.md
          guidance_file_tokens: 650
          needs:                ${{ needs.general-collate.outputs.needs }}
          dry_run:              ${{ inputs.dry_run }}

  keys-values-comment:
    needs:
      - triage-logic
      - keys-values-validate
      - homeconnect-api-changelog-fetch
    if: needs.triage-logic.outputs.type == 'keys-values'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: AI review of issue and API changelog
        id: inference
        uses: thoukydides/action-issue-ai-summary@v1
        with:
          gemini_api_key:       ${{ secrets.GEMINI_API_KEY_TRIAGE }}
          issue_number:         ${{ needs.triage-logic.outputs.issue_number }}
          include_comments:     ${{ inputs.include_comments != false }}
          prompt_file:          ${{ format('.github/prompts/issue-api-keys-{0}.prompt.yml', needs.keys-values-validate.outputs.status) }}
          input_prompt_tokens:  900 # Measured using https://aistudio.google.com/prompts/new_chat
          prompt_vars: |
            review: >-
              ${{ needs.keys-values-validate.outputs.context }}
            comment: ${{ toJSON(needs.keys-values-validate.outputs.comment) }}
            releases: >-
              ${{ needs.homeconnect-api-changelog-fetch.outputs.value }}

      - name: Process the model's output
        id: post
        uses: actions/github-script@v7
        env:
          STATUS:           ${{ needs.keys-values-validate.outputs.status }}
          ORIGINAL_COMMENT: ${{ needs.keys-values-validate.outputs.comment }}
          RESPONSE:         ${{ steps.inference.outputs.response }}
        with:
          result-encoding: string
          script: | # javascript
            const response = JSON.parse(process.env.RESPONSE);

            // Determine which comment to use
            const comment = response.revised_comment || process.env.ORIGINAL_COMMENT;

            // Fail if not posting the comment
            if (!response.post_comment) {
                core.setFailed('Not posting comment automatically');
            }

            // Determine whether to close the issue
            let close_issue = false;
            switch (process.env.STATUS) {
            case 'updates':
                // Ignore any request to close the issue if updates required
                break;
            case 'done':
                // Valid report, but no code changes required
                if (response.close_issue) close_issue = true;
                else core.warning('Not closing done issue automatically');
                break;
            case 'invalid':
                // Wrong issue template used
                if (response.close_issue) {
                    close_issue = true;
                    core.setOutput('labels_set', ['invalid']);
                } else core.warning('Not closing invalid issue automatically');
                break;
            default:
                core.setFailed(`Invalid status: ${process.env.STATUS}`);
            }

            // Set common outputs
            core.setOutput('comment',       comment);
            core.setOutput('post_comment',  response.post_comment);
            core.setOutput('close_issue',   close_issue);
            
      - name: Post comment
        if: ${{ steps.post.outputs.post_comment }}
        uses: thoukydides/action-post-issue-comment@v1
        with:
          issue_number: ${{ needs.triage-logic.outputs.issue_number }}
          body:         ${{ steps.post.outputs.comment }}
          labels_set:   ${{ steps.post.outputs.labels_set }}
          close_issue:  ${{ steps.post.outputs.close_issue }}
          marker:       '<!-- ai-triage-analysis -->'
          dry_run:      ${{ inputs.dry_run }}