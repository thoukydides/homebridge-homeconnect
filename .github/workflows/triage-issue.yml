name: Triage Issue
permissions:
  issues: write
  contents: read
  models: read

on:
  issues:
    types: [opened]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number'
        required: true
        type: number
      dry_run:
        description: 'Dry run (do not modify issue)'
        type: boolean
        default: true

jobs:
  test:
    runs-on: ubuntu-latest
    outputs:
      name: Plugin Test (${{ steps.context.outputs.version }})
      value: ${{ steps.context.outputs.value }}
      prompt: |-
        Automated test of HEAD (latest development version) start-up against Homebridge and the live Home Connect API.
        This tests basic start-up and connectivity.
        If the test only shows routine start-up with no related commits or errors, assess applicability based on whether start-up testing can diagnose the specific issue type.
        Ignore any errors that might be due to appliances being off-line.
        Check for commit messages or log highlights that might indicate fixes or changes related to the reported issue.
    env:
      LOG_FILE: ${{ github.workspace }}/test.log
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js ${{ matrix.node-version }} 
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      - name: Install dependencies and build
        run: | #shell
          npm ci
          npm install homebridge
          cp -R ./.devcontainer/.homebridge ~/
          npm run build
      - id: test
        name: Run the tests
        env:
          HOMECONNECT_CLIENT_PHYSICAL:  ${{ secrets.HOMECONNECT_CLIENT_PHYSICAL }}
          HOMECONNECT_CLIENT_SIMULATOR: ${{ secrets.HOMECONNECT_CLIENT_SIMULATOR }}
        run: | # shell
          npm run test 2>&1 | tee "$LOG_FILE"
          echo "exit_code=${PIPESTATUS[0]}" >> "$GITHUB_OUTPUT"
      - name: Process the test result
        id: context
        uses: thoukydides/action-test-context@v1
        with:
          exit_code: ${{ steps.test.outputs.exit_code }}
          log_file: ${{ env.LOG_FILE }}
          log_regexps: |
            /(?<!\w)v?\d+\.\d+\.\d+/

  api-status:
    runs-on: ubuntu-latest
    outputs:
      name: Home Connect API status
      prompt: |-
        Live monitoring of Home Connect cloud API availability and errors.
        States prefixed with 'maybe-' indicate uncertainty about fault location, not lower severity.
        Only relevant to issues that could be caused by API unavailability or errors.
      value: ${{ steps.fetch.outputs.status }}
    steps:
      - name: Retrieve Home Connect API status
        id: fetch
        env:
          AUTHORIZATION: Bearer ${{ secrets.HOMECONNECT_STATUS_BEARER_TOKEN }}
          URL: https://homeconnect.thouky.co.uk/api/data/context
        run: | # shell
          STATUS=$(curl -s -H "Authorization: $AUTHORIZATION" "$URL")
          printf 'status=%s\n' "$STATUS" >> "$GITHUB_OUTPUT"

  api-changelog:
    runs-on: ubuntu-latest
    outputs:
      name: Home Connect API changelog
      prompt: |-
        Official changelog for the Home Connect cloud API.
        Only relevant if the issue could be caused by API changes (new appliance types, new programs/options, API behaviour changes).
      value: ${{ steps.fetch.outputs.result }}
    steps:
      - name: Retrieve Home Connect API changelog
        id: fetch
        uses: actions/github-script@v7
        env:
          URL: https://developer.home-connect.com/changelog
          MAX_ENTRIES: 10
        with:
          script: | # javascript
            // Fetch the changelog
            const response = await fetch(process.env.URL);
            if (!response.ok) throw new Error(`HTTP error: ${response.status} ${response.statusText}`);
            const page = await response.text();

            // Extract the individual changelog entries from the page
            const CHANGELOG_ENTRY_RE = /<div class="field__item">.*?<header[^>]*>(.*?)<\/header>\s*<div[^>]*>(.*?)<\/div>/gs
            const matches = [...page.matchAll(CHANGELOG_ENTRY_RE)];
            if (matches.length === 0) throw new Error('Regex did not match any changelog entries');

            // Tidy up and return the changelog entries
            const entries = matches.map(([, heading, body]) => ({
                heading:    heading
                    .replaceAll(/<[^>]+>/g, '').trim(),                     // Remove HTML tags
                body:       body
                    .replace(/<a [^>]*href="[^"]*"[^>]*>(.*?)<\/a>/g, '$1') // Remove links
                    .replaceAll(/\s+/g, ' ').trim()                         // Collapse whitespace
            }));
            return entries.slice(0, process.env.MAX_ENTRIES);

  homebridge-releases:
    runs-on: ubuntu-latest
    outputs:
      name: Homebridge recent releases
      value: ${{ steps.fetch.outputs.releases }}
    steps:
      - name: Retrieve Homebridge releases
        id: fetch
        uses: thoukydides/action-releases-context@v1
        with:
          repository: homebridge/homebridge
          max_tokens: 1000

  homebridge-ui-releases:
    runs-on: ubuntu-latest
    outputs:
      name: Homebridge UI recent releases
      value: ${{ steps.fetch.outputs.releases }}
    steps:
      - name: Retrieve Homebridge UI releases
        id: fetch
        uses: thoukydides/action-releases-context@v1
        with:
          repository: homebridge/homebridge-config-ui-x
          max_tokens: 1000

  hap-nodejs-releases:
    if: false
    runs-on: ubuntu-latest
    outputs:
      name: HAP-NodeJS recent releases
      value: ${{ steps.fetch.outputs.releases }}
    steps:
      - name: Retrieve HAP-NodeJS releases
        id: fetch
        uses: thoukydides/action-releases-context@v1
        with:
          repository: homebridge/HAP-NodeJS

  collate:
    runs-on: ubuntu-latest
    if: ${{ !cancelled() }}
    needs:
    - test
    - api-status
    - api-changelog
    - homebridge-releases
    - homebridge-ui-releases
    - hap-nodejs-releases
    steps:
    - name: AI issue triage
      uses: thoukydides/action-triage-issue-comment@v1
      with:
        issue_number: ${{ github.event.issue.number || fromJson(inputs.issue_number) }}
        needs: ${{ toJSON(needs) }}
        dry_run: ${{ inputs.dry_run }}